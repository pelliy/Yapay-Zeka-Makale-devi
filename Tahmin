import pandas as pd
import numpy as np
import unicodedata

from sklearn.preprocessing import LabelEncoder
from sklearn.ensemble import RandomForestClassifier


#  Excel'in okunduğu kısım
df = pd.read_excel("gercek_veri.xlsx")


#  Sütun adları temizlendi ve düzenlendi
def temizle(col):
    col = col.strip().upper()
    col = unicodedata.normalize("NFKD", col)
    col = "".join(c for c in col if not unicodedata.combining(c))
    col = col.replace(" ", "_")
    return col

df.columns = [temizle(c) for c in df.columns]


#  Kullanılacak kolonlar seçildi

MAGAZA_COL = "MAGAZA_ADI"
URUN_COL = "URUN_AILESI"
SATIS_COL = "SON_HAFTA_SATIS_MIKTARI"
STOK_COL = "MAGAZA_STOK"


#  Veri tipi ve boş değerler uygun şekilde dolduruldu

df[SATIS_COL] = pd.to_numeric(df[SATIS_COL], errors="coerce")
df[STOK_COL] = pd.to_numeric(df[STOK_COL], errors="coerce")

df[SATIS_COL].fillna(df[SATIS_COL].median(), inplace=True)
df[STOK_COL].fillna(df[STOK_COL].median(), inplace=True)

df[MAGAZA_COL].fillna(df[MAGAZA_COL].mode()[0], inplace=True)
df[URUN_COL].fillna(df[URUN_COL].mode()[0], inplace=True)


# Stok ihtiyacı etiketi

df["GERCEK_IHTIYAC"] = np.where(
    df[SATIS_COL] > df[STOK_COL],
    1,
    0
)


#  Gerçek stok etiketi oluşturuldu

le_magaza = LabelEncoder()
le_urun = LabelEncoder()

df["MAGAZA_ENC"] = le_magaza.fit_transform(df[MAGAZA_COL])
df["URUN_ENC"] = le_urun.fit_transform(df[URUN_COL])


# Model eğitimi kısmı

X = df[[SATIS_COL, STOK_COL, "MAGAZA_ENC", "URUN_ENC"]]
y = df["GERCEK_IHTIYAC"]

model = RandomForestClassifier(
    n_estimators=250,
    random_state=42
)
model.fit(X, y)


# Tahmin

df["TAHMIN_IHTIYAC"] = model.predict(X)


#  Çıktı alınan kısım: mağaza – ürün ailesi – ihtiyaç olarak kategorilendi

ihtiyac_df = df[df["TAHMIN_IHTIYAC"] == 1][
    [
        MAGAZA_COL,
        URUN_COL,
        SATIS_COL,
        STOK_COL
    ]
].sort_values(by=SATIS_COL, ascending=False)


#  Excel çıktısı alındı

ihtiyac_df.to_excel(
    "magaza_urun_stok_ihtiyac_tahmini.xlsx",
    index=False
)


# Ekran çıktısı

print("\n✅ Stok ihtiyacı tahmin edilen mağaza & ürün aileleri:\n")
print(ihtiyac_df)
